# --------------------- ğŸ“¦ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ ---------------------
import os
import json
import asyncio
import nest_asyncio
from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup,
    BotCommand, ReplyKeyboardMarkup, KeyboardButton
)
from telegram.ext import (
    ApplicationBuilder, Application, CommandHandler,
    MessageHandler, CallbackQueryHandler, ContextTypes, filters
)
from TicTacToe import tictactoe, handle_move, handle_new_game

# --------------------- âš™ï¸ Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§ ---------------------
ADMIN_ID = 6870943715
DATA_FILE = "bimax.json"
all_users = set()
group_ids = set()
user_states = {}

# --------------------- ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---------------------
def save_data():
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump({"users": list(all_users), "groups": list(group_ids)}, f, ensure_ascii=False, indent=2)

def load_data():
    global all_users, group_ids
    if os.path.exists(DATA_FILE) and os.path.getsize(DATA_FILE) > 0:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
            all_users = set(data.get("users", []))
            group_ids = set(data.get("groups", []))

# --------------------- ğŸš€ ÙØ±Ù…Ø§Ù† /start ---------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.type != "private":
        return

    user_id = update.effective_user.id
    all_users.add(user_id)
    save_data()

    keyboard = [[KeyboardButton("âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø³")]]
    if user_id == ADMIN_ID:
        keyboard.append([KeyboardButton("ğŸ› ï¸ Ø­Ø§Ù„Øª Ø§Ø¯Ù…ÛŒÙ†")])

    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text("Ø³Ù„Ø§Ù…! Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†:", reply_markup=reply_markup)

# --------------------- ğŸ’¬ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ ---------------------
async def handle_private_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    msg = update.message
    if not msg or msg.chat.type != "private":
        return

    user_id = msg.from_user.id
    all_users.add(user_id)
    save_data()
    text = msg.text or ""

    # Ø­Ø§Ù„Øª Ø§Ø¯Ù…ÛŒÙ†
    if user_id == ADMIN_ID:
        if text == "ğŸ› ï¸ Ø­Ø§Ù„Øª Ø§Ø¯Ù…ÛŒÙ†":
            admin_kb = [
                [KeyboardButton("ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")],
                [KeyboardButton("ğŸ‘¥ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§")],
                [KeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª")]
            ]
            await msg.reply_text("ğŸ› ï¸ Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯:", reply_markup=ReplyKeyboardMarkup(admin_kb, resize_keyboard=True))
            return

        elif text == "ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†":
            await msg.reply_text(f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {len(all_users)}")
            return

        elif text == "ğŸ‘¥ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§":
            if not group_ids:
                await msg.reply_text("Ù‡ÛŒÚ† Ú¯Ø±ÙˆÙ‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.")
                return

            response = "ğŸ“‹ Ù„ÛŒØ³Øª Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§:\n\n"
            for gid in group_ids:
                try:
                    chat = await context.bot.get_chat(gid)
                    name = chat.title or "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"
                    username = f"@{chat.username}" if chat.username else "â›” Ù†Ø¯Ø§Ø±Ø¯"
                    response += f"â€¢ <b>{name}</b>\n  Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ: <code>{gid}</code>\n  Ø¢ÛŒØ¯ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ: {username}\n\n"
                except:
                    response += f"â€¢ Ø¢ÛŒØ¯ÛŒ: <code>{gid}</code> (â›” Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù…ÙˆÙÙ‚)\n\n"

            await msg.reply_text(response, parse_mode="HTML")
            return

        elif text == "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª":
            await start(update, context)
            return

    # Ø­Ø§Ù„Øª Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ø´Ù†Ø§Ø³
    if text == "âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø³":
        user_states[user_id] = "awaiting_anonymous_message"
        await msg.reply_text("âœï¸ Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ ÛŒÚ© Ø±Ø³Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†...")
        return

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø³
    if user_states.get(user_id) == "awaiting_anonymous_message":
        await forward_anonymous_to_admin(msg, context)
        user_states[user_id] = None
    if user_id == ADMIN_ID and context.user_data.get("reply_to_user_id"):
        reply_to = context.user_data["reply_to_user_id"]
        try:
            if msg.text:
                await context.bot.send_message(chat_id=reply_to, text=f"ğŸ“© Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:\n\n{msg.text}")
            elif msg.photo:
                await context.bot.send_photo(chat_id=reply_to, photo=msg.photo[-1].file_id, caption="ğŸ“¸ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
            elif msg.voice:
                await context.bot.send_voice(chat_id=reply_to, voice=msg.voice.file_id, caption="ğŸ™ï¸ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
            elif msg.video:
                await context.bot.send_video(chat_id=reply_to, video=msg.video.file_id, caption="ğŸ¥ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
            elif msg.audio:
                await context.bot.send_audio(chat_id=reply_to, audio=msg.audio.file_id, caption="ğŸµ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
            elif msg.document:
                await context.bot.send_document(chat_id=reply_to, document=msg.document.file_id,
                                                caption="ğŸ“ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
            elif msg.sticker:
                await context.bot.send_sticker(chat_id=reply_to, sticker=msg.sticker.file_id)

            await msg.reply_text("âœ… Ù¾Ø§Ø³Ø® Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        except Exception as e:
            await msg.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®: {e}")
        context.user_data["reply_to_user_id"] = None  # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª
        return
# --------------------- ğŸ” ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† + Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ø³Ø® ---------------------
async def forward_anonymous_to_admin(msg, context):
    user = msg.from_user
    user_info = f"<b>ğŸ‘¤ From ID:</b> <a href='tg://user?id={user.id}'>{user.id}</a>"
    if user.username:
        user_info += f" | <b>Username:</b> @{user.username}"

    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("âœ‰ï¸ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†", callback_data=f"replyto|{user.id}")
    ]])

    media_sent = False

    try:
        if msg.text:
            await context.bot.send_message(
                chat_id=ADMIN_ID,
                text=f"{user_info}\n\nğŸ“© Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø³:\n\n{msg.text}",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            media_sent = True
        elif msg.photo:
            await context.bot.send_photo(
                chat_id=ADMIN_ID,
                photo=msg.photo[-1].file_id,
                caption=f"{user_info}\nğŸ“¸ Ø¹Ú©Ø³ Ù†Ø§Ø´Ù†Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            media_sent = True
        elif msg.voice:
            await context.bot.send_voice(
                chat_id=ADMIN_ID,
                voice=msg.voice.file_id,
                caption=f"{user_info}\nğŸ™ï¸ ÙˆÛŒØ³ Ù†Ø§Ø´Ù†Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            media_sent = True
        elif msg.video:
            await context.bot.send_video(
                chat_id=ADMIN_ID,
                video=msg.video.file_id,
                caption=f"{user_info}\nğŸ¥ ÙˆÛŒØ¯ÛŒÙˆ Ù†Ø§Ø´Ù†Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            media_sent = True
        elif msg.audio:
            await context.bot.send_audio(
                chat_id=ADMIN_ID,
                audio=msg.audio.file_id,
                caption=f"{user_info}\nğŸµ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ù†Ø§Ø´Ù†Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            media_sent = True
        elif msg.document:
            await context.bot.send_document(
                chat_id=ADMIN_ID,
                document=msg.document.file_id,
                caption=f"{user_info}\nğŸ“ ÙØ§ÛŒÙ„ Ù†Ø§Ø´Ù†Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.",
                reply_markup=keyboard,
                parse_mode="HTML"
            )
            media_sent = True
        elif msg.sticker:
            await context.bot.send_sticker(chat_id=ADMIN_ID, sticker=msg.sticker.file_id, reply_markup=keyboard)
            media_sent = True
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø³: {e}")

    if media_sent:
        await msg.reply_text("âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
    else:
        await msg.reply_text("âŒ Ø§ÛŒÙ† Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.")

# --------------------- ğŸ® Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ø¨Ø§Ø²ÛŒ ---------------------
async def show_game_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[InlineKeyboardButton("ğŸ® Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ²", callback_data="menu_tictactoe")]]
    markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text("ğŸŒ¹ ÛŒÚ© Ø¨Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=markup)
    else:
        await update.message.reply_text("ğŸŒ¹ ÛŒÚ© Ø¨Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=markup)

# --------------------- ğŸ® Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù…Ù†ÙˆÛŒ Ø¨Ø§Ø²ÛŒ ---------------------
async def handle_game_menu_click(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data
    if data == "menu_tictactoe":
        await tictactoe(update, context)


    elif query.data == "menu_admin":
        admin_kb = [
            [InlineKeyboardButton("ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†", callback_data="admin_users")],
            [InlineKeyboardButton("ğŸ‘¥ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§", callback_data="admin_groups")],
            [InlineKeyboardButton("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="menu_back")]
        ]
        await query.edit_message_text("ğŸ› ï¸ Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª:", reply_markup=InlineKeyboardMarkup(admin_kb))

    elif query.data == "admin_users":
        await query.edit_message_text(f"ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {len(all_users)}")

    elif query.data == "admin_groups":
        if not group_ids:
            await query.edit_message_text("Ù‡ÛŒÚ† Ú¯Ø±ÙˆÙ‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.")
            return

        lines = []
        for gid in group_ids:
            try:
                chat = await context.bot.get_chat(gid)
                name = chat.title or "Ù†Ø§Ù…Ø´Ø®Øµ"
                public = f"@{chat.username}" if chat.username else "â›” Ù†Ø¯Ø§Ø±Ø¯"
                lines.append(f"â€¢ <b>{name}</b>\n  Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ: <code>{gid}</code>\n  Ø¢ÛŒØ¯ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ: {public}")
            except:
                lines.append(f"â€¢ Ø¢ÛŒØ¯ÛŒ: <code>{gid}</code> (â›” Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª)")

        await query.edit_message_text("ğŸ“‹ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡:\n\n" + "\n\n".join(lines), parse_mode="HTML")

    elif query.data == "menu_back":
        await show_game_menu(update, context)

# --------------------- ğŸ‘¥ Ø«Ø¨Øª Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ ---------------------
async def track_group(update: Update, context: ContextTypes.DEFAULT_TYPE):
    group_ids.add(update.effective_chat.id)
    save_data()

# --------------------- â— Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ ---------------------
async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    print(f"â— Exception: {context.error}")

# --------------------- âš™ï¸ ØªØ¹Ø±ÛŒÙ ÙØ±Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª ---------------------
async def set_bot_commands(app: Application):
    await app.bot.set_my_commands([
        BotCommand("play", "ğŸ‹ï¸ Ù…Ù†ÙˆÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²ÛŒ"),
        BotCommand("tictactoe", "ğŸ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ²"),
    ])

# --------------------- ğŸ“¨ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ú©Ù…Ù‡ ---------------------
async def handle_admin_reply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.id != ADMIN_ID:
        return

    user_id = context.user_data.get("reply_to_user_id")
    if not user_id:
        return

    try:
        if update.message.text:
            await context.bot.send_message(chat_id=user_id, text=f"ğŸ“© Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:\n\n{update.message.text}")
        elif update.message.photo:
            await context.bot.send_photo(chat_id=user_id, photo=update.message.photo[-1].file_id, caption="ğŸ“¸ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
        elif update.message.voice:
            await context.bot.send_voice(chat_id=user_id, voice=update.message.voice.file_id, caption="ğŸ™ï¸ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
        elif update.message.video:
            await context.bot.send_video(chat_id=user_id, video=update.message.video.file_id, caption="ğŸ¥ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
        elif update.message.audio:
            await context.bot.send_audio(chat_id=user_id, audio=update.message.audio.file_id, caption="ğŸµ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
        elif update.message.document:
            await context.bot.send_document(chat_id=user_id, document=update.message.document.file_id, caption="ğŸ“ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†:")
        elif update.message.sticker:
            await context.bot.send_sticker(chat_id=user_id, sticker=update.message.sticker.file_id)

        await update.message.reply_text("âœ… Ù¾Ø§Ø³Ø® Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        context.user_data["reply_to_user_id"] = None  # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¢ÛŒØ¯ÛŒ
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®: {e}")

# --------------------- âœ‰ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø¯Ú©Ù…Ù‡ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù† Ø§Ø² Ø§Ø¯Ù…ÛŒÙ† ---------------------
async def handle_reply_button_click(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.from_user.id != ADMIN_ID:
        return

    try:
        user_id = int(query.data.split("|")[1])
        context.user_data["reply_to_user_id"] = user_id
        await query.message.reply_text("âœï¸ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ ØªØ§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯.")
    except:
        await query.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±.")

# --------------------- ğŸŸ¢ Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø¨Ø§Øª ---------------------
async def main():
    load_data()
    app = ApplicationBuilder().token(os.environ["BOT_TOKEN"]).build()

    # ÙØ±Ù…Ø§Ù†â€ŒÙ‡Ø§
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("play", show_game_menu))
    app.add_handler(CommandHandler("tictactoe", tictactoe))

    # Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ (Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ø­ØªÛŒ Ø§Ø¯Ù…ÛŒÙ†)
    app.add_handler(MessageHandler(filters.ChatType.PRIVATE, handle_private_message))

    # Ø«Ø¨Øª Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§
    app.add_handler(MessageHandler(filters.ChatType.GROUPS, track_group))

    # Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† (ØªØ±ØªÛŒØ¨: Ø®Ø§Øµ â†’ Ø¹Ù…ÙˆÙ…ÛŒ)
    app.add_handler(CallbackQueryHandler(handle_move, pattern=r"^move\|"))
    app.add_handler(CallbackQueryHandler(handle_reply_button_click, pattern=r"^replyto\|"))
    app.add_handler(CallbackQueryHandler(handle_new_game, pattern="^new_game$"))
    app.add_handler(CallbackQueryHandler(handle_game_menu_click))  # Ø§ÛŒÙ† Ø¢Ø®Ø± Ø¨Ø§Ø´Ù‡ Ú†ÙˆÙ† Ú©Ù„ÛŒÙ‡

    # Ù‡Ù†Ø¯Ù„ Ø®Ø·Ø§Ù‡Ø§
    app.add_error_handler(error_handler)

    # ØªØ¹Ø±ÛŒÙ ÙØ±Ù…Ø§Ù†â€ŒÙ‡Ø§
    await set_bot_commands(app)

    print("\033[32m Bimax is running... âœ… \033[0m")
    await app.run_polling()

# --------------------- â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---------------------
if __name__ == "__main__":
    nest_asyncio.apply()
    asyncio.run(main())
